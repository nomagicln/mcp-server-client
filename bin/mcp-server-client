#!/usr/bin/env node

/**
 * MCP Server Client CLI
 *
 * å…¨å±€å®‰è£…åçš„å‘½ä»¤è¡Œå…¥å£
 */

import { spawn } from 'child_process';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

// è·å–å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// æ„å»ºä¸»å…¥å£æ–‡ä»¶è·¯å¾„
const mainScript = join(__dirname, '..', 'src', 'index.js');

// è§£æå‘½ä»¤è¡Œå‚æ•°
const args = process.argv.slice(2);

// æ”¯æŒçš„å‘½ä»¤
const commands = {
  start: {
    description: 'å¯åŠ¨ MCP æœåŠ¡å™¨',
    action: () => startServer(),
  },
  version: {
    description: 'æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯',
    action: () => showVersion(),
  },
  help: {
    description: 'æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯',
    action: () => showHelp(),
  },
  'list-transports': {
    description: 'åˆ—å‡ºæ”¯æŒçš„ä¼ è¾“æ–¹å¼',
    action: () => listTransports(),
  },
};

/**
 * å¯åŠ¨æœåŠ¡å™¨
 */
function startServer() {
  console.log('ğŸš€ å¯åŠ¨ MCP Server Client...');

  // è§£æä¼ è¾“å‚æ•°
  const transportIndex = args.findIndex(
    arg => arg === '--transport' || arg === '-t',
  );
  const nodeArgs = [mainScript];

  if (transportIndex !== -1 && args[transportIndex + 1]) {
    nodeArgs.push('--transport', args[transportIndex + 1]);
    console.log(`ğŸ“¡ ä½¿ç”¨ä¼ è¾“æ–¹å¼: ${args[transportIndex + 1]}`);
  }

  // å¯åŠ¨ä¸»æœåŠ¡å™¨è¿›ç¨‹
  const child = spawn('node', nodeArgs, {
    stdio: 'inherit',
    env: { ...process.env, NODE_ENV: 'production' },
  });

  // å¤„ç†è¿›ç¨‹ä¿¡å·
  process.on('SIGINT', () => {
    console.log('\nâš ï¸  æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');
    child.kill('SIGINT');
  });

  process.on('SIGTERM', () => {
    console.log('\nâš ï¸  æ”¶åˆ°ç»ˆæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');
    child.kill('SIGTERM');
  });

  // ç›‘å¬å­è¿›ç¨‹é€€å‡º
  child.on('exit', (code, signal) => {
    if (signal) {
      console.log(`\nâœ… æœåŠ¡å™¨å·²é€šè¿‡ä¿¡å· ${signal} åœæ­¢`);
    } else {
      console.log(
        `\n${code === 0 ? 'âœ…' : 'âŒ'} æœåŠ¡å™¨å·²é€€å‡ºï¼Œé€€å‡ºç : ${code}`,
      );
    }
    process.exit(code || 0);
  });

  child.on('error', error => {
    console.error('âŒ å¯åŠ¨æœåŠ¡å™¨æ—¶å‘ç”Ÿé”™è¯¯:', error.message);
    process.exit(1);
  });
}

/**
 * æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
 */
async function showVersion() {
  try {
    const packagePath = join(__dirname, '..', 'package.json');
    const { default: pkg } = await import(packagePath, {
      with: { type: 'json' },
    });

    console.log(`ğŸ“¦ MCP Server Client v${pkg.version}`);
    console.log(`ğŸ  ä¸»é¡µ: ${pkg.repository?.url || 'N/A'}`);
    console.log(`ğŸ‘¤ ä½œè€…: ${pkg.author || 'N/A'}`);
    console.log(`ğŸ“ è®¸å¯è¯: ${pkg.license || 'N/A'}`);
  } catch (error) {
    console.error('âŒ æ— æ³•è¯»å–ç‰ˆæœ¬ä¿¡æ¯:', error.message);
    process.exit(1);
  }
}

/**
 * åˆ—å‡ºæ”¯æŒçš„ä¼ è¾“æ–¹å¼
 */
function listTransports() {
  console.log(`
ğŸš€ MCP Server Client - æ”¯æŒçš„ä¼ è¾“æ–¹å¼

ğŸ“¡ å¯ç”¨ä¼ è¾“æ–¹å¼:
  stdio              æ ‡å‡†è¾“å…¥è¾“å‡ºä¼ è¾“ï¼ˆé»˜è®¤ï¼‰
  sse                æœåŠ¡å™¨å‘é€äº‹ä»¶ä¼ è¾“
  http               HTTP æµå¼ä¼ è¾“

ğŸŒŸ ä½¿ç”¨æ–¹æ³•:
  mcp-server-client start --transport stdio    # ä½¿ç”¨ stdio
  mcp-server-client start --transport sse      # ä½¿ç”¨ SSE
  mcp-server-client start --transport http     # ä½¿ç”¨ HTTP
  
  # ç®€åŒ–å†™æ³•
  mcp-server-client start -t sse               # ä½¿ç”¨ SSE
  mcpsc start -t http                          # ä½¿ç”¨ HTTP

ğŸ“‹ ä¼ è¾“æ–¹å¼è¯´æ˜:
  stdio    - é€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºé€šä¿¡ï¼Œé€‚åˆæœ¬åœ°è¿›ç¨‹è°ƒç”¨
  sse      - é€šè¿‡ Server-Sent Events é€šä¿¡ï¼Œæ”¯æŒ Web å®¢æˆ·ç«¯
  http     - é€šè¿‡ HTTP POST é€šä¿¡ï¼Œæ”¯æŒ RESTful å®¢æˆ·ç«¯

ğŸ”§ ç¯å¢ƒå˜é‡:
  MCP_TRANSPORT=sse                           # è®¾ç½®é»˜è®¤ä¼ è¾“æ–¹å¼
  MCP_SSE_PORT=3001                          # SSE ç«¯å£
  MCP_HTTP_PORT=3002                         # HTTP ç«¯å£
`);
}

/**
 * æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
 */
function showHelp() {
  console.log(`
ğŸ”§ MCP Server Client - å‘½ä»¤è¡Œå·¥å…·

ğŸ“– ä½¿ç”¨æ–¹æ³•:
  mcp-server-client <command> [options]
  mcpsc <command> [options]         # ç®€åŒ–å‘½ä»¤

ğŸ“‹ å¯ç”¨å‘½ä»¤:
`);

  // æ˜¾ç¤ºæ‰€æœ‰å‘½ä»¤
  Object.entries(commands).forEach(([cmd, info]) => {
    console.log(`  ${cmd.padEnd(12)} ${info.description}`);
  });

  console.log(`
ğŸ“š ç¤ºä¾‹:
  mcp-server-client start          å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆé»˜è®¤ stdioï¼‰
  mcp-server-client start -t sse   ä½¿ç”¨ SSE ä¼ è¾“å¯åŠ¨
  mcp-server-client start -t http  ä½¿ç”¨ HTTP ä¼ è¾“å¯åŠ¨
  mcp-server-client version        æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
  mcp-server-client list-transports åˆ—å‡ºæ”¯æŒçš„ä¼ è¾“æ–¹å¼
  
  mcpsc start -t sse               ä½¿ç”¨ç®€åŒ–å‘½ä»¤å’Œ SSE ä¼ è¾“

ğŸŒ æ›´å¤šä¿¡æ¯:
  æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£: https://github.com/nomagicln/mcp-server-client

ğŸ”§ å¼€å‘å‘½ä»¤ (åœ¨é¡¹ç›®ç›®å½•ä¸­):
  make help                        æŸ¥çœ‹æ‰€æœ‰ Makefile å‘½ä»¤
  npm run dev                      å¼€å‘æ¨¡å¼å¯åŠ¨
  npm test                         è¿è¡Œæµ‹è¯•
`);
}

/**
 * ä¸»å‡½æ•°
 */
function main() {
  // å¦‚æœæ²¡æœ‰å‚æ•°æˆ–å‚æ•°ä¸ºç©ºï¼Œæ˜¾ç¤ºå¸®åŠ©
  if (args.length === 0) {
    showHelp();
    return;
  }

  const command = args[0];

  // æ‰§è¡Œå‘½ä»¤
  if (commands[command]) {
    commands[command].action();
  } else {
    console.error(`âŒ æœªçŸ¥å‘½ä»¤: ${command}`);
    console.log('ğŸ’¡ è¿è¡Œ "mcp-server-client help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
    process.exit(1);
  }
}

// å¤„ç†æœªæ•è·çš„å¼‚å¸¸
process.on('uncaughtException', error => {
  console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error.message);
  process.exit(1);
});

process.on('unhandledRejection', reason => {
  console.error('âŒ æœªå¤„ç†çš„ Promise æ‹’ç»:', reason);
  process.exit(1);
});

// å¯åŠ¨ CLI
main();
